#!/bin/bash
#set -x
WALK="snmpwalk -c public -v 1"
OIDS=(
ifName
ifDescr
ifSpeed
ifLastChange
ifInOctets
ifOutOctets
)
#vlans enterasys
#snmpwalk -c public -v1 22arroba .1.3.6.1.2.1.17.7.1.4.2.1.3.0
#vlan de cada puerto
#snmpwalk -c public -v1 22arroba .1.3.6.1.2.1.17.7.1.4.5.1.1
#nombre de la Vlan
#snmpwalk -c public -v1 22arroba .1.3.6.1.2.1.17.7.1.4.3.1.1
#Alias de cada interface
#snmpwalk -c public -v1 22arroba .1.3.6.1.2.1.31.1.1.1.18

until [ -z "$1" ]
do
	echo -e "\e[1;32m#\n#\t${1}\n#\e[0m"
	if [ `ping -c 1 $1 > /dev/null 2>&1 ; echo $?` = "0" ] ; then
		
		# Vlan stuff
		VLANCOUNT=$($WALK $1 .1.3.6.1.2.1.17.7.1.1.4.0 | perl -ne 'print "$&" if /\d+$/')
		if [ $VLANCOUNT > 0 ]; then
		        echo -e "\e[1;33m# Hay $VLANCOUNT VLANs definidas:\e[0m"
		        VLANLIST=$($WALK $1 .1.3.6.1.2.1.17.7.1.4.2.1.3.0 | perl -ne 'print "$& " if /\d+$/')
		        for element in ${VLANLIST[@]} ; do
		                VLANAME=$($WALK $1 .1.3.6.1.2.1.17.7.1.4.3.1.1.$element | perl -ne 'print "$&\n" if /(?<=STRING: ")[^"]*/')
		                if [ -x $VLANAME ] ; then VLANAME="NULL" ; fi
		                echo "$element $VLANAME"
		        	VLANS="${VLANS}${element}[${VLANAME}]"
			done
		else echo -e "\e[1;31m# No hay  VLANS definidas.\e[0m"; fi
		
		# Bucle en ifs up
		for i in $(seq 1 `$WALK $1 ifNumber.0 | egrep -o '[0-9]+$'`) 
		do
			if [ `$WALK $1 ifOperStatus.$i | egrep -q 'up\(1\)$' ; echo $?` == "0" ] ; then
				echo -e "\e[1;33m#\n#\tInterface ${i}\n#\e[0m"
				for element in ${OIDS[@]} ; do
					echo `$WALK $1 ${element}.${i}`
				done
				PALIAS=$($WALK $1 .1.3.6.1.2.1.31.1.1.1.18.$i | perl -ne 'print "$&" if /(?<=STRING: ).*$/')
				if [ ! -x $PALIAS ] ; then echo "Alias= $PALIAS" ; fi
				if [ $VLANCOUNT > 0 ]; then
					PVID=$($WALK $1 .1.3.6.1.2.1.17.7.1.4.5.1.1.$i | perl -ne 'print "$&" if /\d+$/')
					PVL=$(echo $VLANS | perl -ne 'print "$&\n" if /'$PVID'\[[^\]]*\]/')
				fi
				echo "Vlan = $PVL"
			fi
		done
	else echo -e "\e[1;31m# No hay ping.\e[0m"; fi
	shift
done
